require 'rubygems'
require 'pathname'
Bundler.require(:default)

include FileUtils::Verbose

task :weekly => [:'weekly:brew', :'weekly:blake', :'weekly:trailers']

namespace :weekly do
  require 'open-uri'
  require 'nokogiri'
  task :trailers do
    RSS = 'http://gdata.youtube.com/feeds/base/users/FilmsActuTrailers/uploads?alt=rss&v=2&orderby=published&client=ytapi-youtube-profile'
    doc = Nokogiri::XML(open(RSS))
    links = doc.css('rss item link').map(&:inner_html)

    TRAILER_PATH = Pathname.new(Dir.home).join 'downloads', 'trailers'
    TRAILER_PATH.mkdir unless TRAILER_PATH.exist?
    links_params = links.map{|l| "'#{l}'"}.join(' ')

    cd (TRAILER_PATH) do
      sh "youtube-dl -lic --format 38/37/22/35/34/18/6/5/17/13 #{links_params}"
    end
  end

  task :blake do
    Bundler.with_clean_env do
      cd (Pathname.new(Dir.home) + 'projects/blake') do
        sh 'bundle exec rake update'
      end
    end
  end

  task :brew do
    Bundler.with_clean_env do
      sh 'brew update'
      sh 'brew upgrade'
      sh 'brew cleanup'
    end
  end
end

task :js do
  Dir['*.js'].each do |js|
    puts "#{js}..."
    puts File.read(js).gsub(/(\n|\t)/,'')
    puts
  end
end

desc 'Picks a random picture from the iPhoto Library'
task :random_picture do
  dir = '/Users/tansengming/Pictures/iPhoto Public Library/Originals'
  file = Dir.glob(dir + '/**/*.jp*').shuffle.first
  sh "open #{file.gsub(' ', '\ ')}"
end

task :download => [:'download:link', :'download:all', :'download:fix_filenames']

Cocaine::CommandLine.logger = Logger.new(STDOUT)

namespace :download do
  DownloadPath = Pathname.new('Downloads')
  ListFile = DownloadPath + 'list'

  task :link do
    list = Pathname.new(File.expand_path('~/Downloads/list'))
    blake_list  = Pathname.new(File.expand_path('~/Dropbox/Blake Documents/list'))
    next if (list.exist? or !blake_list.exist?)
    list.make_symlink blake_list
  end

  task :all do
    ListFiles = Pathname.glob('Downloads/**/list')
    next if ListFiles.empty?

    ListFiles.each do |listfile|
      list = listfile.read.split.compact.reject(&:empty?)

      while list.any?
        url = list.shift
        cd listfile.dirname do
          if url[/(vimeo|youtube)\.com/]
            sh "youtube-dl -lic --format 38/37/22/35/34/18/6/5/17/13 '#{url}'"
          elsif url[/(put)\.io/]
            Cocaine::CommandLine.new("wget", "--http-user=sengming --http-password='RWIGQMKEAZ' '#{url}'").run
          else
            Cocaine::CommandLine.new("wget", "-c -U 'QuickTime/7.6.2' '#{url}'").run
          end
        end
        File.open(listfile, 'w') {|f| f.write list.join("\n")}
      end
      listfile.delete
    end
    sh 'open ~/Downloads'
  end

  task :fix_filenames do
    cd DownloadPath do
      Pathname.glob('makeplaylist.*').reject{|p| p.to_s[/mp4$/]}.each do |f|
        f.rename(f.to_s + '.mp4')
      end
    end
  end
end

namespace :ruby do
  task :update do
    # $ cd ~/.rbenv
    # $ git pull
    # remove /opt/local/bin from path
    # rbenv install 1.9.3-p12 # latest ruby ver
    # rbenv rehash
  end
end